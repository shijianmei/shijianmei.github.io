---
title: 启动优化
date: 2023-01-21 11:17:46
tags:
categories: 
- iOS优化

---
# 启动过程：
![](https://raw.githubusercontent.com/shijianmei/blog_Images/main/%E5%90%AF%E5%8A%A8%E4%BC%98%E5%8C%96/%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%9B%BE%E7%89%87.png)

启动过程以main为界限，分为pre-main和main之后两部分

## pre-main
### 加载dyld
动态库载入过程，会去装载app使用的动态库。而每一个动态库有它自己的依赖关系，会消耗时间去查找和读取。
### rebase&binding
rebase：主要是调整镜像内部的指针，这里使用了ASLR(Address Space Layout Randomization 地址空间布局随机化)。程序每次启动后地址都会随机变化，这样程序里的所有代码地址都需要重新进行计算修复

binding：修复指向外部的指针。比如app中调用了NSLog函数打印信息，NSLog是系统函数，在程序开始运行的时候app是不知道NSLog函数指针是多少，此时就需要通过dyld_stub_binder技术找到NSLog指针地址进行调用。

### Objc setup
runtime在此处初始化，对class和category进行注 册，selector唯一性判断

load&constructor&initialize

调用所有类的load的方法，初始化C&C++的静态化变量，然后调用 constructor 函数

## main之后
### main函数
创建整个app的autoreleasepool，初始化初始window，app界面开始展示

### LifeCyle
指定rootviewcontroller，调用业务代码，完成各阶段业务

### First Frame
main页面viewDidAppear 完成页面第一帧渲染。至此启动完成。

# 分析工具
## pre-main阶段耗时分析:
在 Xcode 中 Edit scheme -> Run -> Auguments 将环境变量 DYLD_PRINT_STATISTICS 设为1

```powershell
Total pre-main time: 1.2 seconds (100.0%)
dylib loading time: 297.95 milliseconds (23.5%)
rebase/binding time: 100.67 milliseconds (7.9%)
ObjC setup time: 110.68 milliseconds (8.7%)
initializer time: 758.19 milliseconds (59.8%)
slowest intializers :
libSystem.B.dylib : 6.71 milliseconds (0.5%)
libMainThreadChecker.dylib : 40.29 milliseconds (3.1%)
GPUToolsCore : 37.95 milliseconds (2.9%)
libglInterpose.dylib : 363.65 milliseconds (28.6%)
AiWayFashionCar : 471.71 milliseconds (37.2%)
```
如果将 Edit scheme -> Run > Auguments 将环境变量 DYLD_PRINT_STATISTICS_DETAILS 设为1，则可以更多详细的pre-main阶段的耗时：
```plain
total time: 2.1 seconds (100.0%)
total images loaded: 526 (508 from dyld shared cache)
total segments mapped: 66, into 8235 pages
total images loading time: 1.0 seconds (49.3%)
total load time in ObjC: 124.33 milliseconds (5.8%)
total debugger pause time: 753.19 milliseconds (35.7%)
total dtrace DOF registration time: 0.00 milliseconds (0.0%)
total rebase fixups: 830,184
total rebase fixups time: 95.24 milliseconds (4.5%)
total binding fixups: 851,403
total binding fixups time: 523.97 milliseconds (24.8%)
total weak binding fixups time: 3.85 milliseconds (0.1%)
total redo shared cached bindings time: 533.55 milliseconds (25.3%)
total bindings lazily fixed up: 0 of 0
total time in initializers and ObjC +load: 320.90 milliseconds (15.2%)
kscrash libSystem.B.dylib : 6.78 milliseconds (0.3%)
libBacktraceRecording.dylib : 6.98 milliseconds (0.3%)
libobjc.A.dylib : 2.52 milliseconds (0.1%)
libMainThreadChecker.dylib : 40.53 milliseconds (1.9%)
Flutter : 2.95 milliseconds (0.1%)
AiWayFashionCar : 396.86 milliseconds (18.8%)
total symbol trie searches: 1793354
total symbol table binary searches: 0
total images defining weak symbols: 63
total images using weak symbols: 143
```
备注:这里要跑低于ios 15.0的系统,才会在控制台打印
## 项目里用到的动态库：

通过命令 **otool****-****L** +  包路径查看使用了的动态库（包含系统库、嵌入的动态库）：

```plain
otool -L /Users/mac/Desktop/Debugiphoneos/AiWayFashionCar.app/AiWayFashionCar
```
执行结果如下:
```plain
/usr/lib/libbz2.1.0.dylib (compatibility version 1.0.0, current version 1.0.8)
/usr/lib/libc++.1.dylib (compatibility version 1.0.0, current version 1200.3.0)
/usr/lib/libsqlite3.dylib (compatibility version 9.0.0, current version 331.0.0)
/usr/lib/libz.1.dylib (compatibility version 1.0.0, current version 1.2.11)
@rpath/ATAuthSDK_D.framework/ATAuthSDK_D (compatibility version 1.0.0, current version 1.0.0)
@rpath/App.framework/App (compatibility version 0.0.0, current version 0.0.0)
/System/Library/Frameworks/AssetsLibrary.framework/AssetsLibrary (compatibility version 1.0.0, current version 1.0.0)
/System/Library/Frameworks/AudioToolbox.framework/AudioToolbox (compatibility version 1.0.0, current version 1000.0.0)
/System/Library/Frameworks/CFNetwork.framework/CFNetwork (compatibility version 1.0.0, current version 1327.0.4)
/System/Library/Frameworks/EventKit.framework/EventKit (compatibility version 1.0.0, current version 1716.2.2)
@rpath/FMDB.framework/FMDB (compatibility version 1.0.0, current version 1.0.0)
@rpath/Flutter.framework/Flutter (compatibility version 0.0.0, current version 0.0.0)
/System/Library/Frameworks/Foundation.framework/Foundation (compatibility version 300.0.0, current version 1856.105.0)
/System/Library/Frameworks/GLKit.framework/GLKit (compatibility version 1.0.0, current version 126.0.0)
/System/Library/Frameworks/ImageIO.framework/ImageIO (compatibility version 1.0.0, current version 1.0.0)
/System/Library/Frameworks/WebKit.framework/WebKit (compatibility version 1.0.0, current version 612.3.6)
@rpath/flutter_boost.framework/flutter_boost (compatibility version 1.0.0, current version 1.0.0)
@rpath/path_provider.framework/path_provider (compatibility version 1.0.0, current version 1.0.0)
@rpath/shared_preferences.framework/shared_preferences (compatibility version 1.0.0, current version 1.0.0)
@rpath/sqflite.framework/sqflite (compatibility version 1.0.0, current version 1.0.0)
@rpath/video_player.framework/video_player (compatibility version 1.0.0, current version 1.0.0)
@rpath/wakelock.framework/wakelock (compatibility version 1.0.0, current version 1.0.0)
@rpath/webview_flutter.framework/webview_flutter (compatibility version 1.0.0, current version 1.0.0)
/System/Library/Frameworks/AppTrackingTransparency.framework/AppTrackingTransparency (compatibility version 1.0.0, current version 1.0.0, weak)
/System/Library/Frameworks/UserNotifications.framework/UserNotifications (compatibility version 1.0.0, current version 1.0.0, weak)
/usr/lib/libobjc.A.dylib (compatibility version 1.0.0, current version 228.0.0)
/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1311.0.0)
/System/Library/Frameworks/AVKit.framework/AVKit (compatibility version 1.0.0, current version 1.0.0)
/usr/lib/libnetwork.dylib (compatibility version 1.0.0, current version 1.0.0, weak)
...
```
* 这里以/System ,/usr开头的是系统动态库
* 以@rpath开头的是嵌入动态库,如u3d,flutter及其依赖项使用了动态库
## 查找无用类、分类

代码覆盖率检测等

[AppCode](https://www.jetbrains.com/objc/download/)

基于LLVM插件检测重复代码或者未被使用的代码

[GitHub - erduoniba/hdcoverage: iOS（swift&amp;oc）自动注入代码覆盖率指令脚本，](https://github.com/erduoniba/hdcoverage)

## 查看项目里调了哪些load方法：

如果将 Edit scheme -> Run > Auguments 环境变量里加：OBJC_PRINT_LOAD_METHODS 设为YES

```plain
objc[11939]: LOAD: +[NSMutableDictionary(SwizzlSafe) load]
objc[11939]: LOAD: +[NSNull(SwizzSafe) load]
objc[11939]: LOAD: +[NSString(SwizzlSafe) load]
objc[11939]: LOAD: +[NSMutableString(SwizzlSafe) load]
objc[11939]: LOAD: +[UIControl(AW) load]
objc[11939]: LOAD: +[UIApplication(MemoryLeak) load]
objc[11939]: LOAD: +[UINavigationController(MemoryLeak) load]
objc[11939]: LOAD: +[UITouch(MemoryLeak) load]
objc[11939]: LOAD: +[UIViewController(MemoryLeak) load]
objc[11939]: LOAD: +[NSObject(JPInjecting) load]
objc[11939]: LOAD: +[UITextView(RCSBackWord) load]
objc[11939]: LOAD: +[UITabBarController(ShouldAutorotate) load]
objc[11939]: LOAD: +[UIApplication(BaiduMobStatApplication) load]
objc[11939]: LOAD: +[UICollectionViewLayout(MJRefresh) load]
objc[11939]: LOAD: +[UIScrollView(MJExtension) load]
objc[11939]: LOAD: +[NSObject(MJKeyValue) load]
```
## 缺页异常引起的耗时分析:
打开 `Instruments` , 选择 System Trace 
![](https://raw.githubusercontent.com/shijianmei/blog_Images/main/%E5%90%AF%E5%8A%A8%E4%BC%98%E5%8C%96/%E7%BC%BA%E9%A1%B5%E4%B8%AD%E6%96%AD%E5%89%8D.png)
![](https://raw.githubusercontent.com/shijianmei/blog_Images/main/%E5%90%AF%E5%8A%A8%E4%BC%98%E5%8C%96/%E7%BC%BA%E9%A1%B5%E4%B8%AD%E6%96%AD%E5%90%8E.png)
## main之后各阶段耗时分析:
打开 `Instruments` , 选择 App Launch , Time Profile
![](https://raw.githubusercontent.com/shijianmei/blog_Images/main/%E5%90%AF%E5%8A%A8%E4%BC%98%E5%8C%96/%E8%80%97%E6%97%B6%E5%88%86%E6%9E%90.png)
结合
```plain
NSDate* tmpStartData = [NSDate date];    
//耗时函数    
double deltaTime = [[NSDate date] timeIntervalSinceDate:tmpStartData];
NSLog(@">>>>>>>>>>unity_launch_costTime = %f ms", deltaTime*1000);
```
# 优化思路
## pre-main优化
### 二进制重排
为了能减少系统因缺页中断产生的 Page In 操作，我们需要做的就是把启动链路上所有用到的方法都排在连续的页上，这样系统在加载符号的时候就可以减少相应的内存页数量的访问，从而减少整个启动过程的耗时

### 动态库改造:
项目用到的嵌入动态库主要是U3d,Flutter及其依赖库

U3d库因为有要求必须得用动态库,故不作改造

这里只把flutter依赖库改造为静态库,思路是在flutter模块的podfile里添加:

```plain
post_install do |installer|
  installer.pods_project.targets.each do |target|
    target.build_configurations.each do |config|    
      config.build_settings['MACH_O_TYPE'] = 'staticlib'
    end
  end
end
```
Flutter的引入是通过构建脚本生成动态库,然后导入到私有库引用,故这里直接更改构建脚本
脚本更改：

```plain
sed -i '' '38a\
    target.build_configurations.each do |config|\
     config.build_settings['MACH_O_TYPE'] = 'staticlib'\
    end\    
' Podfile

```
需要安装gsed
```plain
brew install gnu-sed
alias sed='gsed'
```
### load方法改造
从原则上来说，我们在开发过程中不应该使用 +load,针对 +load 方法的优化，主要是采用如下几种方案：

* 删除不必要的代码； 
*  +load中代码延迟到 main 之后子线程处理或者首页显示之后； 
* 业务代码接口懒加载； 
*  改为 initialize 中执行，针对 initialize 中处理需要注意的是分类 initialize 会覆盖主类 initialize 以及有子类后 initialize 执行多次的问题，需要使用 dispatch_once 来保证代码只执行一次; 
### 删除无用代码
删减没有被调用或者已经废弃的方法

## main后优化：
### 三方SDK
有些三方 SDK 的启动耗时很高，将第三方SDK延后或并发。

### 远程配置
一些远程配置,如社区详情页支持flutter和H5方式展示,通过开关来控制,城市列表信息等,改为并发请求

### 图片
用 Asset 管理图片而不是直接放在 bundle 里。

Asset 会在编译期做优化，让加载的时候更快。此外在 Asset 中加载图片是要比 Bundle 快的，因为 UIImage imageNamed 要遍历 Bundle 才能找到图。

### 高耗时方法
Flutter引擎初始化较为耗时,项目里用到的主要是二级页,故将它放在加载第一帧之后再初始化

### 首帧渲染
#### 自动布局
自动布局改为frame布局方式,以提升布局性能

#### 默认启动页
除了第一次装包会显示倒计时启动页,之后每次启动都会显示一个默认启动页,和该默认启动页并发展示的是最终要展示的社区首页,因为社区首页需要网络请求加载数据,之前的方案为了每次冷启后不先展示一片空白影响用户体验,故先展示一个1s的默认启动页.

这里把默认启动页去掉,对首页数据进行了缓存,初次装包后会对请求的数据进行缓存,之后启动会直接初始化社区首页,并从缓存加载数据

#### 懒加载其它Tab页
启动只加载推荐页，发现页、口碑页、排行榜、活动页等，点击时候再加载

# 优化效果
| 阶段        | 优化耗时 |
| --------   |  :----:  |
| 动态库改造     |  90ms     |
| 二进制重排      |    270ms   |
| load方法改造      |   160ms  |
| main之后 | 1.3s |






