---
title: 热修复设计
date: 2023-05-06 19:04:10
categories: 
- 系统设计
tags:
---

# 为什么要搭建热修复平台

随着公司的快速发展，需求的快速增加，App迭代也越来越频繁，如果移动应用出现问题，不仅仅影响用户体验，还会影响公司口碑，甚至可能造成资损。需要快速修复线上问题，对比常规的开发流程而言，热修复更加灵活方便，优势很多：

● 无需重新发版，实时高效修复bug；
● 用户无感知修复，无需下载新的版本，代价小；
● 修复成功率高，能把损失降到最低；
● 因此热修平台愈加重要，需要搭建一个高效，好用且安全的热修复平台。

# 具体设计：

## 流程图：

链路流程图:

![](https://raw.githubusercontent.com/shijianmei/blog_Images/main/%E7%83%AD%E4%BF%AE%E5%A4%8D%E8%AE%BE%E8%AE%A1/%E9%93%BE%E8%B7%AF%E6%B5%81%E7%A8%8B%E5%9B%BE.png)

## 时序图：

![](https://raw.githubusercontent.com/shijianmei/blog_Images/main/%E7%83%AD%E4%BF%AE%E5%A4%8D%E8%AE%BE%E8%AE%A1/%E6%8B%89%E5%8C%85%E6%97%B6%E5%BA%8F%E5%9B%BE.png)
 
## 各平台要做的事情

### 热修复管理平台：

热修复管理系统分前后端，主要支持补丁的上传、发布、停止，用户角色的创建及管理，以及供客户端调的接口：获取热修复包、是否存在最新修复包两个接口

#### 上传补丁：

![](https://raw.githubusercontent.com/shijianmei/blog_Images/main/%E7%83%AD%E4%BF%AE%E5%A4%8D%E8%AE%BE%E8%AE%A1/%E4%BF%AE%E5%A4%8D%E5%8C%85%E6%B7%BB%E5%8A%A0.png)

上传补丁到服务端和app包的某一个版本号一一对应

#### 管理补丁：

![](https://raw.githubusercontent.com/shijianmei/blog_Images/main/%E7%83%AD%E4%BF%AE%E5%A4%8D%E8%AE%BE%E8%AE%A1/%E4%BF%AE%E5%A4%8D%E5%8C%85%E7%AE%A1%E7%90%86.png)

补丁状态说明：

|状态|说明|
|:----|:----|
|已就绪|补丁上传成功，等待操作。|
|灰度中|补丁正在进行部分设备灰度发布中。|
|已发布|补丁已全量发布至所有设备。|
|已停止|补丁发布行为已暂停，服务端停止下发补丁，客户端已经下载的补丁继续生效。|

#### 发布补丁：

发布之后，app端即可拉去到有效的补丁

#### 停止发布：

在补丁列表的操作里点终止操作，不在下发到客户端

#### 数据相关：

|参数|说明|
|:----|:----|
|通知设备|本次补丁下发包含的所有设备数。|
|下载成功设备|补丁已下载成功的所有设备数。|
|加载成功设备|补丁已加载成功的所有设备数。|
|主动清除成功数|客户端调用清除补丁接口或者控制台操作全部回滚后补丁清除成功的设备数。|


### 客户端库：

基于 MangoFix 封装, 实现了拉修复包，缓存，修复等功能。

设计流程图:

![](https://raw.githubusercontent.com/shijianmei/blog_Images/main/%E7%83%AD%E4%BF%AE%E5%A4%8D%E8%AE%BE%E8%AE%A1/%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%97%B6%E5%BA%8F%E5%9B%BE.png)

基于补丁是从服务端拉取的,有一定的延时,为了不影响启动时间及代码修复,同时也为了减少每次冷启重复的请求，故加入缓存机制。

### 辅助工具

在修复完线上问题后需要制作补丁包上传到服务端，该工具为此提供了便利

* 补丁脚本生成功能：
补丁脚本是类oc语法，与OC语法还是有些差异，通过该工具生成补丁脚本，可节约时间，减少错误

* 补丁包生成功能：
最终上传到服务器的补丁包是基于补丁脚本通过AES加密生成一个二进制文件流，通过导出包功能最终生成上传到服务端的补丁包

## 发布策略：

全量发布：

    全量发布，不用解释，补丁对应版本App所有用户都可拉取补丁

灰度发布：

    灰度下发支持按人数灰度 与 按比例灰度，按照人数灰度相对简单，因此这里只说下按比例灰度，灰度如果按照总人数的百分比进行下发，有可能会下发到不活跃用户的设备上，让百分比下发失去意义。目前一个简单的方式是实现哈希碰撞算法，概率可调，当App端请求补丁时，根据设备的唯一标识进行碰撞，落到概率区间内则下发补丁。

条件发布：

    需要在小范围内进行验证，比如特定某个系统版本或者特定某个用户；在验证通过后再进行全网用户的下发，这中场景下可以使用条件下发。

## 传输安全：

对补丁进行AES加密，生成二进制文件

## 监控：

    修复情况（crash监控等）
    拉取补丁设备数

# 完成度：

- [x] [热修复管理系统具前端](https://github.com/shijianmei/hotfixMS) 
- [x] [热修复管理系统具前端后端](https://git@github.com:shijianmei/hotfixServer.git)
- [x] [热修复脚本生成工具](https://git@github.com:shijianmei/PatchGenerater.git)
- [x] [iOS端热修复库封装](https://github.com/shijianmei/ProblemTerminator)
- [ ] 条件发布、灰度发布
- [ ] 数据指标统计（补丁读取耗时、补丁读取成功设备数）






